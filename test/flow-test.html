<!doctype html>
<html>
<head>
  <title>qowt-page test</title>

  <!-- The order of loading is important here.
  The test frameworks must be loaded before requirejs.-->
  <script src="../bower_components/platform/platform.js" type="text/javascript"></script>

  <link rel="stylesheet" href="../node_modules/mocha/mocha.css" />
  <script src="../node_modules/mocha/mocha.js" type="text/javascript"></script>
  <script src="../node_modules/chai/chai.js" type="text/javascript"></script>
  <script src="../utils/lodash.min.js" type="text/javascript"></script>

  <!-- Set up our test environment -->
  <script src="./htmlTest.js"></script>

  <script src="../utils/require.min.js" type="text/javascript"></script>
  <script>
    require.config({
      baseUrl: "../"
    });
  </script>

  <!-- Finally load our Polymer element -->
  <link rel="import" href="../elements/doc.html">
  <link rel="import" href="../elements/section.html">
  <link rel="import" href="../elements/page.html">
  <link rel="import" href="../elements/para.html">

</head>

<body>

  <!--
  We are testing the recursive balancing of child elements.
  So we create a test configuration of elements which flow
  their children. Note how we thus do not use <qowt-run> elements
  since they flow words, not children.

  And we use a template here so we can stamp this test
  html out for multiple tests.
  -->

  <div id="mocha"></div>

  <div id="T">
    <qowt-doc>
      <qowt-page>
        <qowt-section>
          <p is='qowt-para'>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
          </p>
        </qowt-section>
      </qowt-page>
    </qowt-doc>
  </div>

  <div id="testDiv"></div>

  <script>
    var assert = chai.assert;
    var expect = chai.expect;

    mocha.setup('bdd');

    function overflowFunc_(page, spansToFit) {
      var spansOnPage = page.querySelectorAll('span');
      var overflow = spansOnPage.length > spansToFit;
      return overflow;
    }

    // The main test loop
    function test_() {

      describe("flow children", function() {

        var templ = document.getElementById('T');
        var testDiv = document.getElementById('testDiv');

        beforeEach(function() {
          // testDiv.appendChild(templ.content.cloneNode(true));
          testDiv.appendChild(templ.cloneNode(true));
          testDiv.appendChild(document.createElement('qowt-doc'));
        });
        afterEach(function() {
          // while (testDiv.firstChild) {
          //   testDiv.removeChild(testDiv.firstChild);
          // }
        });

        it("should flow all children recursively", function() {
          var doc = testDiv.querySelector('qowt-doc');
          var pages = doc.querySelectorAll('qowt-page');
          var allSpans = doc.querySelectorAll('span');

          // test by only supporting 2 spans on the first page
          var fit2Spans = overflowFunc_.bind(null, pages[0], 2);
          pages[0].isOverflowing = fit2Spans;

          doc.paginate(pages[0]);

          pages = doc.querySelectorAll('qowt-page');
          expect(pages.length).to.equal(2);

          var spansOnPage1 = pages[0].querySelectorAll('span');
          var spansOnPage2 = pages[1].querySelectorAll('span');
          expect(spansOnPage1.length).to.equal(2);
          expect(spansOnPage2.length).to.equal(allSpans.length - spansOnPage1.length);
        });

        it("should do something B", function() {
          expect(true).to.equal(false);
        });

      });

      // running as part of karma
      if (window.top !== window) {

        mocha.setup({
          reporter: function(runner) {
            runner.on('fail', function(a,b,c) {
              console.log('fail');
              setTimeout(function() {
                throw b;
              },0);
            });
            runner.on('end', function(x) {
              console.log('end');
              done();
            });
          }
        });
      }

      mocha.run();
    }


    whenReady().then(test_)
      // .then(done)
      .catch(function(e) {
        setTimeout(function() {
          throw e;
        },0);
      });

  </script>
</body>
</html>